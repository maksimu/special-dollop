# Cursor AI Rules for pam-guacr

## Essential Reading (Auto-loaded)

Before starting any work, read these files:

1. **docs/CLAUDE.md** - Complete project overview, architecture, and development guidelines
2. **COMMUNICATION_GUIDELINES.md** - How to interact with the user (no summary docs!)
3. **docs/START_HERE.md** - Current implementation status and quick start

## Key Guidelines

### What NOT to do:
- ❌ Do NOT create summary documents (*.md files in root)
- ❌ Do NOT commit changes unless explicitly requested
- ❌ Do NOT use emojis in code/comments/commits
- ❌ Do NOT use Mutex<Vec<T>> - use ArrayQueue
- ❌ Do NOT allocate buffers per frame - use buffer pools
- ❌ Do NOT copy pixel data - use bytes::Bytes

### What TO do:
- ✅ Read docs/CLAUDE.md for architecture and patterns
- ✅ Use lock-free concurrency (ArrayQueue, parking_lot::RwLock)
- ✅ Use zero-copy techniques (bytes::Bytes, buffer pools)
- ✅ Follow async patterns (tokio, no blocking)
- ✅ Run `cargo clippy` before finishing

## Architecture Quick Reference

**Protocol Handlers:**
- guacr-ssh (PRODUCTION READY)
- guacr-telnet (Complete)
- guacr-rdp (Complete with ironrdp)
- guacr-vnc (Complete)
- guacr-database (MySQL/PostgreSQL/SQL Server/Oracle/MongoDB/Redis)
- guacr-sftp (Complete)
- guacr-rbi (Complete with chromiumoxide)

**Core Principles:**
1. Zero-copy I/O (bytes::Bytes everywhere)
2. Lock-free concurrency (ArrayQueue, not Mutex)
3. Buffer pooling (no per-frame allocations)
4. SIMD acceleration (AVX2/NEON with scalar fallback)
5. Async/await (tokio runtime)

## Performance Requirements

- <100ms latency for input events
- 30+ FPS for graphical protocols
- 10,000+ concurrent connections per instance
- <10MB memory per connection

## Testing

Always run before committing:
```bash
cargo test
cargo clippy -- -D warnings
cargo build --workspace
```

## Documentation Structure

- `docs/` - All official documentation
- `docs/CLAUDE.md` - **START HERE** - Complete guide
- `docs/START_HERE.md` - Implementation status
- `docs/development/` - Development guides
- `docs/docs/context/` - Architecture deep dives
- `docs/docs/reference/original-guacd/` - Original C implementation reference

## Common Patterns

**Protocol Handler:**
```rust
#[async_trait]
impl ProtocolHandler for MyHandler {
    async fn connect(
        &self,
        params: HashMap<String, String>,
        to_client: mpsc::Sender<Bytes>,
        from_client: mpsc::Receiver<Bytes>,
    ) -> Result<()> {
        // Implementation
    }
}
```

**Buffer Pool:**
```rust
let mut buf = buffer_pool.acquire();
encoder.encode_into(&mut buf, data)?;
let bytes = buf.freeze(); // Zero-copy via Arc
```

**Lock-Free Queue:**
```rust
let queue = Arc::new(ArrayQueue::<T>::new(1024));
queue.push(item)?;
if let Some(item) = queue.pop() { /* ... */ }
```

## When in Doubt

1. Check docs/CLAUDE.md
2. Look at guacr-ssh (reference implementation)
3. Ask the user for clarification

---

**Remember:** Be direct, concise, and focus on the task. Don't over-document.
