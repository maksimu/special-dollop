name: Build Wheel

on:
  push:
    branches:
      - main
    paths:
      - 'Cargo.toml'
  workflow_dispatch:

jobs:
  # Linux x86_64 build
  build_linux_x86_64:
    name: Build Linux (x86_64)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          architecture: 'x64'

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-unknown-linux-gnu

      - name: Install maturin
        run: |
          python -m pip install --upgrade pip
          pip install maturin==0.15.1
        shell: bash

      - name: Build wheel
        run: |
          echo "Building for Linux x86_64"
          docker run --rm -v "$(pwd)":/io ghcr.io/pyo3/maturin build --release --manylinux 2014
          
          # Debug - list the wheels that were built
          echo "Wheels built for Linux x86_64:"
          find target/wheels -name "*.whl" -type f | sort
        shell: bash

      - name: Setup test environment
        run: |
          pip install virtualenv pytest
          python -m virtualenv venv
          echo "VIRTUAL_ENV=${{ github.workspace }}/venv" >> $GITHUB_ENV
          echo "${{ github.workspace }}/venv/bin" >> $GITHUB_PATH
        shell: bash

      - name: Run tests
        run: |
          . venv/bin/activate
          pip install pytest
          pip install $(find target/wheels -name "*.whl" | head -1)
          python -c "import pam_rustwebrtc; print('Import successful')"
          cd tests && python -m pytest test_webrtc.py -v
        shell: bash

      - uses: actions/upload-artifact@v4
        with:
          name: pam-rustwebrtc-linux-x86_64
          path: target/wheels/*.whl
          retention-days: 14

  # Linux ARM64 build
  build_linux_arm64:
    name: Build Linux (ARM64)
    runs-on: UbuntuArm64
    steps:
      - uses: actions/checkout@v4

      - name: Install Python 3.11 using pyenv
        run: |
          # Install dependencies for pyenv and Python building
          sudo apt-get update
          sudo apt-get install -y build-essential libssl-dev zlib1g-dev \
            libbz2-dev libreadline-dev libsqlite3-dev wget curl llvm \
            libncurses5-dev libncursesw5-dev xz-utils tk-dev libffi-dev \
            liblzma-dev libgdbm-dev libnss3-dev libedit-dev git
          
          # Install pyenv
          curl https://pyenv.run | bash
          
          # Add pyenv to PATH
          export PYENV_ROOT="$HOME/.pyenv"
          export PATH="$PYENV_ROOT/bin:$PATH"
          eval "$(pyenv init -)"
          eval "$(pyenv init --path)"
          
          # Install Python 3.11
          pyenv install 3.11.8
          pyenv global 3.11.8
          
          # Verify installation
          python --version
          pip --version
          
          # Make pyenv settings persist in subsequent steps
          echo 'export PYENV_ROOT="$HOME/.pyenv"' >> ~/.bashrc
          echo 'export PATH="$PYENV_ROOT/bin:$PATH"' >> ~/.bashrc
          echo 'eval "$(pyenv init -)"' >> ~/.bashrc
          echo 'eval "$(pyenv init --path)"' >> ~/.bashrc
        shell: bash

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-unknown-linux-gnu

      - name: Install maturin
        run: |
          python -m pip install --upgrade pip
          pip install maturin==0.15.1
        shell: bash

      - name: Build wheel
        run: |
          echo "Building for Linux ARM64 natively on UbuntuArm64"
          # Build directly without trying to use manylinux
          maturin build --release
          
          # If the basic build fails, try with specific options
          if [ ! -d "target/wheels" ] || [ -z "$(find target/wheels -name '*.whl' 2>/dev/null)" ]; then
            echo "Basic build failed, trying with target specified..."
            mkdir -p target/wheels
            maturin build --release --target aarch64-unknown-linux-gnu
          fi
          
          # Debug - list the wheels that were built
          echo "Wheels built for Linux ARM64:"
          find target -name "*.whl" -type f | sort
          
          # Make sure wheels are in target/wheels directory
          for wheel in $(find target -type f -name "*.whl"); do
            if [[ "$wheel" != "target/wheels/"* ]]; then
              mkdir -p target/wheels
              cp "$wheel" target/wheels/
              echo "Copied $wheel to target/wheels/"
            fi
          done
        shell: bash

      - uses: actions/upload-artifact@v4
        with:
          name: pam-rustwebrtc-linux-arm64
          path: target/wheels/*.whl
          retention-days: 14

  # macOS builds (x86_64 and arm64)
  build_macos:
    name: Build macOS
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          architecture: 'x64'

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-apple-darwin,aarch64-apple-darwin

      - name: Install dependencies
        run: |
          brew install openssl@3

      - name: Install maturin
        run: |
          python -m pip install --upgrade pip
          pip install maturin==0.15.1
        shell: bash

      - name: Build wheels (x86_64 and arm64)
        run: |
          export OPENSSL_DIR=$(brew --prefix openssl@3)
          
          # Build x86_64 wheel
          echo "Building for macOS x86_64"
          maturin build --release --target x86_64-apple-darwin
          
          # Build arm64 wheel
          echo "Building for macOS ARM64"
          maturin build --release --target aarch64-apple-darwin
          
          # Debug - list the wheels that were built
          echo "Wheels built for macOS:"
          find target/wheels -name "*.whl" -type f | sort
        shell: bash

      - uses: actions/upload-artifact@v4
        with:
          name: pam-rustwebrtc-macos
          path: target/wheels/*.whl
          retention-days: 14

  # Windows build
  build_windows:
    name: Build Windows
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          architecture: 'x64'

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: Install maturin
        run: |
          python -m pip install --upgrade pip
          pip install maturin==0.15.1
        shell: bash

      - name: Build wheel
        run: |
          echo "Building for Windows x86_64"
          python -m pip show maturin
          Get-ChildItem target -ErrorAction SilentlyContinue
          maturin build --release --target x86_64-pc-windows-msvc
          
          # Debug - list the wheels that were built
          echo "Wheels built for Windows x86_64:"
          Get-ChildItem target/wheels -Filter "*.whl" -ErrorAction SilentlyContinue | Sort-Object Name
        shell: pwsh

      - name: Setup test environment
        run: |
          pip install virtualenv pytest
          python -m virtualenv venv
          echo "VIRTUAL_ENV=${{ github.workspace }}\venv" >> $GITHUB_ENV
          echo "${{ github.workspace }}\venv\Scripts" >> $GITHUB_PATH
        shell: bash

      - name: Run tests
        run: |
          . venv/Scripts/activate
          pip install pytest
          pip install (Get-ChildItem -Path "target/wheels/*.whl" | Select-Object -First 1).FullName
          python -c "import pam_rustwebrtc; print('Import successful')"
          cd tests && python -m pytest test_webrtc.py -v
        shell: pwsh

      - uses: actions/upload-artifact@v4
        with:
          name: pam-rustwebrtc-windows-x86_64
          path: target/wheels/*.whl
          retention-days: 14

  # Alpine Linux build
  build_alpine:
    name: Build Alpine Linux
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          architecture: 'x64'

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-unknown-linux-musl

      - name: Build Alpine Linux wheel
        run: |
          echo "Building wheel for Alpine Linux"
          
          # Create target directories
          mkdir -p target/wheels
          
          # Use a pure Alpine container for building the musllinux wheel
          # Use root user inside the container but fix permissions after
          docker run --rm -v "$(pwd)":/io alpine:3.16 sh -c "
            # Install build dependencies including patchelf
            apk add --no-cache python3 python3-dev py3-pip gcc g++ musl-dev curl patchelf
          
            # Install Rust
            curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
            source \$HOME/.cargo/env
          
            # Install maturin with patchelf support
            pip3 install 'maturin[patchelf]==0.15.1'
          
            # Build the wheel directly in a temporary directory within the container
            TEMP_DIR=\$(mktemp -d)
            cd /io
          
            # Use maturin to build the wheel with explicit output location
            mkdir -p /io/target/wheels
          
            # First try with strip option (faster)
            echo 'Building wheel with strip option...'
            maturin build --release --strip --out /io/target/wheels || {
              echo 'Strip build failed, trying without strip option...'
              maturin build --release --out /io/target/wheels
            }
          
            # Fix permissions on all generated files so host can access them
            echo 'Fixing permissions on generated files...'
            find /io/target -type d -exec chmod 777 {} \\;
            find /io/target -type f -exec chmod 666 {} \\;
          "
          
          # Check if we have any wheels built after Docker
          WHEEL_COUNT=$(find target -type f -name "*.whl" | wc -l)
          if [ $WHEEL_COUNT -eq 0 ]; then
            # Try alternative maturin direct approach
            echo "No wheels found from Docker approach, trying direct maturin build..."
          
            # Install additional dependencies if needed
            pip install setuptools-rust auditwheel wheel
          
            # Try direct build with maturin
            maturin build --release --interpreter $(which python) --out target/wheels
          
            # Check if direct build produced wheels
            WHEEL_COUNT=$(find target -type f -name "*.whl" | wc -l)
            if [ $WHEEL_COUNT -eq 0 ]; then
              echo "ERROR: No wheels were built after trying all approaches!"
              exit 1
            fi
          fi
          
          # Make sure wheels are in target/wheels directory
          for wheel in $(find target -type f -name "*.whl"); do
            if [[ "$wheel" != "target/wheels/"* ]]; then
              cp "$wheel" target/wheels/
              echo "Copied $wheel to target/wheels/"
            fi
          done
          
          # List all wheels
          echo "Final wheels in target directory:"
          find target -type f -name "*.whl" | sort
        shell: bash

      - name: Test Alpine wheel
        run: |
          echo "Testing wheel in Alpine container"
          
          # Find any wheel to test
          WHEEL_PATH=$(find target -type f -name "*.whl" | head -1)
          
          if [ -z "$WHEEL_PATH" ]; then
            echo "ERROR: No wheels found at all!"
            echo "Contents of target directory:"
            find target -type f | sort
            exit 1
          fi
          
          echo "Testing wheel: $WHEEL_PATH"
          
          # Test in a clean Alpine container
          docker run --rm -v "$(pwd)":/io alpine:latest sh -c "
            # Install Python and pip
            apk add --no-cache python3 py3-pip
          
            # Create a virtual environment as required by PEP 668
            python3 -m venv /tmp/venv
            . /tmp/venv/bin/activate
          
            # Install the wheel
            pip install /io/$WHEEL_PATH
          
            # Verify import works
            python -c 'import pam_rustwebrtc; print(\"Import successful\")'
          
            # Install test dependencies
            pip install pytest
          
            # Run tests
            cd /io/tests && python -m pytest test_webrtc.py -v
          "
        shell: bash

      - uses: actions/upload-artifact@v4
        with:
          name: pam-rustwebrtc-alpine-x86_64
          path: target/wheels/*.whl
          retention-days: 14

  # Create release with all wheels if on main branch
  create_release:
    name: Create Release
    needs: [build_linux_x86_64, build_linux_arm64, build_macos, build_windows, build_alpine]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - name: Get version
        id: get_version
        shell: bash
        run: |
          VERSION=$(grep -m 1 version Cargo.toml | cut -d '"' -f2)
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Download all wheels
        uses: actions/download-artifact@v4
        with:
          path: dist/
          pattern: pam-rustwebrtc-*
          merge-multiple: true

      - name: Debug wheel files
        run: |
          echo "Listing all wheel files in dist/"
          find dist -type f -name "*.whl" | sort
          echo "Contents of each directory:"
          find dist -type d | while read dir; do
            echo "Contents of $dir:"
            ls -la "$dir"
          done
        shell: bash

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/**/*.whl
          name: pam-rustwebrtc ${{ env.VERSION }}
          body: |
            WebRTC Python extension module using Rust

            This release includes wheels for:
            - Linux (x86_64, aarch64)
            - macOS (x86_64, arm64)
            - Windows (x86_64)
            - Alpine Linux (x86_64)
            
            Built with abi3 for maximum Python version compatibility (Python 3.7+).
          tag_name: v${{ env.VERSION }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}