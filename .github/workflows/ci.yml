name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  # CEF version to use (matches cef crate version 142.x)
  # To update: check https://cef-builds.spotifycdn.com/index.html for latest stable
  # Format: VERSION+gCOMMIT+chromium-CHROMIUM_VERSION
  CEF_VERSION: "142.0.17"
  CEF_COMMIT: "g60aac24"
  CEF_CHROMIUM_VERSION: "142.0.7444.176"

jobs:
  # ============================================================================
  # Linting and Formatting
  # ============================================================================
  lint:
    name: Lint & Format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: false

      - name: Check formatting
        run: cargo fmt --all -- --check

      - name: Run clippy
        # Note: Not using --all-features because CEF requires binaries to compile
        run: cargo clippy --all-targets -- -D warnings

  # ============================================================================
  # Unit Tests (no Docker required)
  # ============================================================================
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: false

      - name: Run unit tests
        run: |
          cargo test -p guacr-protocol
          cargo test -p guacr-terminal
          cargo test -p guacr-handlers --lib
          cargo test -p guacr-ssh --lib
          cargo test -p guacr-telnet --lib
          cargo test -p guacr-rdp --lib
          cargo test -p guacr-vnc --lib
          cargo test -p guacr-database --lib
          cargo test -p guacr-rbi --lib
          cargo test -p guacr-sftp --lib
          cargo test -p guacr-threat-detection --lib

      - name: Run pipe integration tests (no Docker)
        run: cargo test -p guacr-handlers --test pipe_integration_test

  # ============================================================================
  # RBI Tests with Chrome Feature
  # ============================================================================
  rbi-chrome-tests:
    name: RBI Tests (Chrome)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: false

      - name: Install Chromium
        run: |
          sudo apt-get update
          sudo apt-get install -y chromium-browser
          chromium-browser --version

      - name: Run RBI tests with Chrome feature
        run: cargo test -p guacr-rbi --features chrome --lib
        env:
          CHROMIUM_PATH: /usr/bin/chromium-browser

  # ============================================================================
  # RBI Tests with CEF Feature (requires CEF binaries)
  # ============================================================================
  # NOTE: The CEF feature requires CEF binaries to be downloaded (~100MB).
  # CEF binaries are cached between runs to minimize download time.
  rbi-cef-tests:
    name: RBI Tests (CEF)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install CEF dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            cmake ninja-build \
            libx11-dev libxrandr-dev libxinerama-dev libxcursor-dev \
            libgl1-mesa-dev libnss3-dev libatk1.0-dev libatk-bridge2.0-dev \
            libcups2-dev libdrm-dev libxcomposite-dev libxdamage-dev \
            libxfixes-dev libgbm-dev libasound2-dev libpangocairo-1.0-0 \
            libgtk-3-dev libdbus-1-dev

      - name: Cache CEF binaries
        id: cache-cef
        uses: actions/cache@v4
        with:
          path: ~/cef
          # v3: Force fresh download with standard distribution (2024-12-04)
          key: cef-linux64-v3-standard-${{ env.CEF_VERSION }}-${{ env.CEF_COMMIT }}

      - name: Download CEF binaries
        if: steps.cache-cef.outputs.cache-hit != 'true'
        run: |
          mkdir -p ~/cef
          cd ~/cef
          
          # Build the filename: cef_binary_VERSION+COMMIT+chromium-CHROMIUM_VERSION_linux64.tar.bz2
          # The + must be URL-encoded as %2B
          # Using STANDARD distribution (not minimal) - minimal lacks some headers the cef crate needs
          CEF_FILENAME="cef_binary_${CEF_VERSION}%2B${CEF_COMMIT}%2Bchromium-${CEF_CHROMIUM_VERSION}_linux64.tar.bz2"
          CEF_URL="https://cef-builds.spotifycdn.com/${CEF_FILENAME}"
          
          echo "Downloading CEF from: $CEF_URL"
          wget -q --show-progress "$CEF_URL" -O cef.tar.bz2
          
          if [ ! -f cef.tar.bz2 ] || [ ! -s cef.tar.bz2 ]; then
            echo "ERROR: Could not download CEF binaries"
            echo "Please check available versions at: https://cef-builds.spotifycdn.com/index.html"
            exit 1
          fi
          
          tar -xjf cef.tar.bz2
          # The archive extracts to cef_binary_VERSION+COMMIT+chromium-CHROMIUM_VERSION_linux64/
          # We need to find and use that directory
          CEF_EXTRACTED_DIR=$(ls -d cef_binary_* 2>/dev/null | head -1)
          if [ -z "$CEF_EXTRACTED_DIR" ]; then
            echo "ERROR: Could not find extracted CEF directory"
            ls -la
            exit 1
          fi
          mv "$CEF_EXTRACTED_DIR" cef
          rm cef.tar.bz2
          
          echo "CEF extracted to ~/cef/cef"
          ls -la ~/cef/cef/
          
          # Create archive.json - required by cef-dll-sys build script
          # This tells the build script what version of CEF is installed
          cat > ~/cef/cef/archive.json << EOF
          {
            "type": "standard",
            "name": "cef_binary_${CEF_VERSION}+${CEF_COMMIT}+chromium-${CEF_CHROMIUM_VERSION}_linux64",
            "sha1": "manual-download"
          }
          EOF
          echo "Created archive.json:"
          cat ~/cef/cef/archive.json

      - name: Verify CEF installation
        run: |
          echo "=== CEF Installation Verification ==="
          echo "CEF_PATH will be: $HOME/cef/cef"
          echo ""
          echo "Contents of ~/cef:"
          ls -la ~/cef/ || echo "~/cef directory not found!"
          echo ""
          echo "Contents of ~/cef/cef:"
          ls -la ~/cef/cef/ || echo "~/cef/cef directory not found!"
          echo ""
          # Check for required directories
          if [ ! -d ~/cef/cef ]; then
            echo "ERROR: CEF directory ~/cef/cef not found"
            exit 1
          fi
          if [ ! -d ~/cef/cef/include ]; then
            echo "ERROR: CEF include directory not found"
            echo "Available directories:"
            find ~/cef -type d -maxdepth 3
            exit 1
          fi
          if [ ! -d ~/cef/cef/Release ]; then
            echo "WARNING: CEF Release directory not found (may be in different location)"
          fi
          echo ""
          echo "CEF installation verified successfully"

      - name: Set CEF environment
        run: |
          echo "CEF_PATH=$HOME/cef/cef" >> $GITHUB_ENV
          echo "LD_LIBRARY_PATH=$HOME/cef/cef/Release:$LD_LIBRARY_PATH" >> $GITHUB_ENV

      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: false

      - name: Debug CEF path before build
        run: |
          echo "CEF_PATH=$CEF_PATH"
          echo ""
          echo "=== CEF root contents ==="
          ls -la $CEF_PATH
          echo ""
          echo "=== CEF Release contents ==="
          ls -la $CEF_PATH/Release || echo "Release dir missing!"
          echo ""
          echo "=== CEF include contents ==="
          ls -la $CEF_PATH/include | head -20
          echo ""
          echo "=== Looking for libcef.so ==="
          find $CEF_PATH -name "libcef.so" -o -name "libcef*.so*" 2>/dev/null || echo "No libcef.so found"

      - name: Build with CEF feature
        run: cargo build -p guacr-rbi --features cef

      - name: Run RBI tests with CEF
        run: cargo test -p guacr-rbi --features cef --lib

  # ============================================================================
  # Build Check (ensure it compiles on multiple platforms)
  # ============================================================================
  build:
    name: Build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: false

      - name: Build all crates
        run: cargo build --all-targets

      - name: Build release
        run: cargo build --release

  # ============================================================================
  # Integration Tests with Docker Services
  # ============================================================================
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [lint, unit-tests]
    services:
      # SSH Server
      ssh:
        image: lscr.io/linuxserver/openssh-server:latest
        env:
          PUID: 1000
          PGID: 1000
          TZ: UTC
          PASSWORD_ACCESS: "true"
          USER_PASSWORD: test_password
          USER_NAME: test_user
          SUDO_ACCESS: "true"
        ports:
          - 2222:2222
        options: >-
          --health-cmd "nc -z localhost 2222 || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: false

      - name: Wait for SSH service
        run: |
          for i in {1..30}; do
            nc -z localhost 2222 && echo "SSH ready" && exit 0
            echo "Waiting for SSH... ($i/30)"
            sleep 2
          done
          echo "SSH service did not start"
          exit 1

      - name: Run SSH integration tests
        run: cargo test -p guacr-ssh --test integration_test -- --include-ignored
        env:
          TEST_SSH_HOST: localhost
          TEST_SSH_PORT: 2222
          TEST_SSH_USER: test_user
          TEST_SSH_PASSWORD: test_password

  # ============================================================================
  # Security Audit
  # ============================================================================
  security:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install cargo-audit
        run: cargo install cargo-audit

      - name: Run security audit
        run: cargo audit
        continue-on-error: true  # Don't fail PR on audit warnings

  # ============================================================================
  # Documentation
  # ============================================================================
  docs:
    name: Documentation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: false

      - name: Check documentation
        # Note: Not using --all-features because CEF requires binaries to compile
        run: cargo doc --no-deps
        env:
          RUSTDOCFLAGS: -D warnings
