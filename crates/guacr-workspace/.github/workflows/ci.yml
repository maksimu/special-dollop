name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  # CEF version to use (matches cef crate version 142.x)
  # To update: check https://cef-builds.spotifycdn.com/index.html for latest stable
  # Format: VERSION+gCOMMIT+chromium-CHROMIUM_VERSION
  CEF_VERSION: "142.0.17"
  CEF_COMMIT: "g60aac24"
  CEF_CHROMIUM_VERSION: "142.0.7444.176"

jobs:
  # ============================================================================
  # Linting and Formatting
  # ============================================================================
  lint:
    name: Lint & Format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Install FreeRDP development libraries
        run: |
          sudo apt-get update
          sudo apt-get install -y freerdp3-dev libwinpr3-dev

      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: false

      - name: Check formatting
        run: cargo fmt --all -- --check

      - name: Run clippy
        # Note: Not using --all-features because CEF requires binaries to compile
        run: cargo clippy --all-targets -- -D warnings

  # ============================================================================
  # Unit Tests (no Docker required)
  # ============================================================================
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install FreeRDP development libraries
        run: |
          sudo apt-get update
          sudo apt-get install -y freerdp3-dev libwinpr3-dev

      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: false

      - name: Run unit tests
        run: |
          cargo test -p guacr-protocol
          cargo test -p guacr-terminal
          cargo test -p guacr-handlers --lib
          cargo test -p guacr-ssh --lib
          cargo test -p guacr-telnet --lib
          cargo test -p guacr-rdp --lib
          cargo test -p guacr-vnc --lib
          cargo test -p guacr-database --lib
          cargo test -p guacr-rbi --lib
          cargo test -p guacr-sftp --lib
          cargo test -p guacr-threat-detection --lib

      - name: Run pipe integration tests (no Docker)
        run: cargo test -p guacr-handlers --test pipe_integration_test

  # ============================================================================
  # RBI Tests with Chrome Feature
  # ============================================================================
  rbi-chrome-tests:
    name: RBI Tests (Chrome)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: false

      - name: Install Chromium
        run: |
          sudo apt-get update
          sudo apt-get install -y chromium-browser
          chromium-browser --version

      - name: Run RBI tests with Chrome feature
        run: cargo test -p guacr-rbi --features chrome --lib
        env:
          CHROMIUM_PATH: /usr/bin/chromium-browser

  # ============================================================================
  # RBI Tests with CEF Feature (requires CEF binaries)
  # ============================================================================
  # NOTE: The CEF feature requires CEF binaries to be downloaded (~100MB).
  # CEF binaries are cached between runs to minimize download time.
  rbi-cef-tests:
    name: RBI Tests (CEF)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install CEF dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            cmake ninja-build \
            libx11-dev libxrandr-dev libxinerama-dev libxcursor-dev \
            libgl1-mesa-dev libnss3-dev libatk1.0-dev libatk-bridge2.0-dev \
            libcups2-dev libdrm-dev libxcomposite-dev libxdamage-dev \
            libxfixes-dev libgbm-dev libasound2-dev libpangocairo-1.0-0 \
            libgtk-3-dev libdbus-1-dev

      - name: Cache CEF binaries
        id: cache-cef
        uses: actions/cache@v4
        with:
          path: ~/cef
          # v3: Force fresh download with standard distribution (2024-12-04)
          key: cef-linux64-v3-standard-${{ env.CEF_VERSION }}-${{ env.CEF_COMMIT }}

      - name: Download CEF binaries
        if: steps.cache-cef.outputs.cache-hit != 'true'
        run: |
          mkdir -p ~/cef
          cd ~/cef
          
          # Build the filename: cef_binary_VERSION+COMMIT+chromium-CHROMIUM_VERSION_linux64.tar.bz2
          # The + must be URL-encoded as %2B
          # Using STANDARD distribution (not minimal) - minimal lacks some headers the cef crate needs
          CEF_FILENAME="cef_binary_${CEF_VERSION}%2B${CEF_COMMIT}%2Bchromium-${CEF_CHROMIUM_VERSION}_linux64.tar.bz2"
          CEF_URL="https://cef-builds.spotifycdn.com/${CEF_FILENAME}"
          
          echo "Downloading CEF from: $CEF_URL"
          wget -q --show-progress "$CEF_URL" -O cef.tar.bz2
          
          if [ ! -f cef.tar.bz2 ] || [ ! -s cef.tar.bz2 ]; then
            echo "ERROR: Could not download CEF binaries"
            echo "Please check available versions at: https://cef-builds.spotifycdn.com/index.html"
            exit 1
          fi
          
          tar -xjf cef.tar.bz2
          # The archive extracts to cef_binary_VERSION+COMMIT+chromium-CHROMIUM_VERSION_linux64/
          # We need to find and use that directory
          CEF_EXTRACTED_DIR=$(ls -d cef_binary_* 2>/dev/null | head -1)
          if [ -z "$CEF_EXTRACTED_DIR" ]; then
            echo "ERROR: Could not find extracted CEF directory"
            ls -la
            exit 1
          fi
          mv "$CEF_EXTRACTED_DIR" cef
          rm cef.tar.bz2
          
          echo "CEF extracted to ~/cef/cef"
          ls -la ~/cef/cef/
          
          # Create archive.json - required by cef-dll-sys build script
          # This tells the build script what version of CEF is installed
          cat > ~/cef/cef/archive.json << EOF
          {
            "type": "standard",
            "name": "cef_binary_${CEF_VERSION}+${CEF_COMMIT}+chromium-${CEF_CHROMIUM_VERSION}_linux64",
            "sha1": "manual-download"
          }
          EOF
          echo "Created archive.json:"
          cat ~/cef/cef/archive.json

      - name: Verify CEF installation
        run: |
          echo "=== CEF Installation Verification ==="
          echo "CEF_PATH will be: $HOME/cef/cef"
          echo ""
          echo "Contents of ~/cef:"
          ls -la ~/cef/ || echo "~/cef directory not found!"
          echo ""
          echo "Contents of ~/cef/cef:"
          ls -la ~/cef/cef/ || echo "~/cef/cef directory not found!"
          echo ""
          # Check for required directories
          if [ ! -d ~/cef/cef ]; then
            echo "ERROR: CEF directory ~/cef/cef not found"
            exit 1
          fi
          if [ ! -d ~/cef/cef/include ]; then
            echo "ERROR: CEF include directory not found"
            echo "Available directories:"
            find ~/cef -type d -maxdepth 3
            exit 1
          fi
          if [ ! -d ~/cef/cef/Release ]; then
            echo "WARNING: CEF Release directory not found (may be in different location)"
          fi
          echo ""
          echo "CEF installation verified successfully"

      - name: Set CEF environment
        run: |
          echo "CEF_PATH=$HOME/cef/cef" >> $GITHUB_ENV
          echo "LD_LIBRARY_PATH=$HOME/cef/cef/Release:$LD_LIBRARY_PATH" >> $GITHUB_ENV

      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: false

      - name: Debug CEF path before build
        run: |
          echo "CEF_PATH=$CEF_PATH"
          echo ""
          echo "=== CEF root contents ==="
          ls -la $CEF_PATH
          echo ""
          echo "=== CEF Release contents ==="
          ls -la $CEF_PATH/Release || echo "Release dir missing!"
          echo ""
          echo "=== CEF include contents ==="
          ls -la $CEF_PATH/include | head -20
          echo ""
          echo "=== Looking for libcef.so ==="
          find $CEF_PATH -name "libcef.so" -o -name "libcef*.so*" 2>/dev/null || echo "No libcef.so found"

      - name: Build with CEF feature
        run: cargo build -p guacr-rbi --features cef

      - name: Run RBI tests with CEF
        run: cargo test -p guacr-rbi --features cef --lib

  # ============================================================================
  # Build Check (ensure it compiles on multiple platforms)
  # ============================================================================
  build:
    name: Build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install FreeRDP (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y freerdp3-dev libwinpr3-dev

      - name: Install FreeRDP (macOS)
        if: runner.os == 'macOS'
        run: brew install freerdp

      - name: Install FreeRDP (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          # Install FreeRDP via vcpkg (GitHub Actions has vcpkg pre-installed)
          vcpkg install freerdp:x64-windows
          
          # Set environment variables for pkg-config and bindgen
          $vcpkgRoot = $env:VCPKG_INSTALLATION_ROOT
          $freerdpDir = "$vcpkgRoot\installed\x64-windows"
          
          # Add to pkg-config path
          echo "PKG_CONFIG_PATH=$freerdpDir\lib\pkgconfig" >> $env:GITHUB_ENV
          
          # Add to library path for linking
          echo "FREERDP_LIB_DIR=$freerdpDir\lib" >> $env:GITHUB_ENV
          echo "FREERDP_INCLUDE_DIR=$freerdpDir\include" >> $env:GITHUB_ENV
          
          # Add DLLs to PATH for runtime
          echo "$freerdpDir\bin" >> $env:GITHUB_PATH
          
          # For bindgen to find headers
          echo "BINDGEN_EXTRA_CLANG_ARGS=-I$freerdpDir\include" >> $env:GITHUB_ENV

      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: false

      - name: Build all crates
        run: cargo build --all-targets

      - name: Build release
        run: cargo build --release

  # ============================================================================
  # Integration Tests with Docker Services
  # ============================================================================
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [lint, unit-tests]
    services:
      # SSH Server (with SFTP support)
      ssh:
        image: keeper/playground-ssh:latest
        env:
          PUID: 1000
          PGID: 1000
          TZ: UTC
          PASSWORD_ACCESS: "true"
          USER_PASSWORD: alpine
          USER_NAME: linuxuser
          SUDO_ACCESS: "true"
        ports:
          - 2222:2222
        options: >-
          --health-cmd "nc -z localhost 2222 || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install FreeRDP development libraries
        run: |
          sudo apt-get update
          sudo apt-get install -y freerdp3-dev libwinpr3-dev

      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: false

      - name: Wait for SSH service
        run: |
          for i in {1..30}; do
            nc -z localhost 2222 && echo "SSH ready" && exit 0
            echo "Waiting for SSH... ($i/30)"
            sleep 2
          done
          echo "SSH service did not start"
          exit 1

      - name: Start Telnet container
        run: |
          docker run -d \
            --name telnet-test \
            -p 2323:23 \
            alpine:latest \
            sh -c "apk add --no-cache busybox-extras shadow && \
                   adduser -D test_user && \
                   echo 'test_user:test_password' | chpasswd && \
                   echo 'root:test_password' | chpasswd && \
                   busybox telnetd -F -l /bin/sh -p 23"
          
          echo "Telnet container started"

      - name: Wait for Telnet service
        run: |
          for i in {1..30}; do
            nc -z localhost 2323 && echo "Telnet ready" && exit 0
            echo "Waiting for Telnet... ($i/30)"
            sleep 2
          done
          echo "Telnet service did not start. Container logs:"
          docker logs telnet-test
          exit 1

      - name: Start RDP container
        run: |
          # Using Keeper's playground RDP image with XFCE
          docker run -d \
            --name rdp-test \
            --shm-size=2g \
            --security-opt seccomp=unconfined \
            -p 3389:3389 \
            -e USER=linuxuser \
            -e PASSWORD=alpine \
            -e ROOT_PASSWORD=rootpassword \
            keeper/playground-rdp-xfce:latest
          
          echo "RDP container started, waiting for xrdp to initialize..."

      - name: Wait for RDP service
        run: |
          echo "Waiting for RDP service to start (xrdp takes ~60 seconds)..."
          for i in {1..90}; do
            if nc -z localhost 3389 2>/dev/null; then
              echo "RDP port is open, waiting a bit more for full initialization..."
              sleep 10
              echo "RDP ready"
              exit 0
            fi
            echo "Waiting for RDP... ($i/90)"
            sleep 2
          done
          echo "RDP service did not start. Container logs:"
          docker logs rdp-test
          exit 1

      - name: Run SSH integration tests
        run: cargo test -p guacr-ssh --test integration_test -- --include-ignored --test-threads=1
        env:
          TEST_SSH_HOST: localhost
          TEST_SSH_PORT: 2222
          TEST_SSH_USER: linuxuser
          TEST_SSH_PASSWORD: alpine

      - name: Run SFTP integration tests
        run: cargo test -p guacr-sftp --test integration_test -- --include-ignored --test-threads=1
        env:
          TEST_SSH_HOST: localhost
          TEST_SSH_PORT: 2222
          TEST_SSH_USER: linuxuser
          TEST_SSH_PASSWORD: alpine

      - name: Run Telnet integration tests
        run: cargo test -p guacr-telnet --test integration_test -- --include-ignored
        env:
          TEST_TELNET_HOST: localhost
          TEST_TELNET_PORT: 2323
          TEST_TELNET_USER: test_user
          TEST_TELNET_PASSWORD: test_password

      - name: Run RDP integration tests
        run: cargo test -p guacr-rdp --test integration_test -- --include-ignored --test-threads=1
        env:
          TEST_RDP_HOST: localhost
          TEST_RDP_PORT: 3389
          TEST_RDP_USER: linuxuser
          TEST_RDP_PASSWORD: alpine

      - name: Run performance tests
        run: cargo test -p guacr-handlers --test performance_test -- --include-ignored

      - name: Run security tests
        run: cargo test -p guacr-handlers --test security_test -- --include-ignored

      - name: Run threat detection tests
        run: cargo test -p guacr-threat-detection --test integration_test -- --include-ignored

      - name: Start VNC container
        run: |
          # Using Keeper's playground VNC image with XFCE
          docker run -d \
            --name vnc-test \
            -p 5900:5901 \
            -e VNC_PW=alpine \
            -e VNC_RESOLUTION=1010x760 \
            keeper/playground-vnc-xfce:latest
          
          echo "VNC container started, waiting for VNC to initialize..."

      - name: Wait for VNC service
        run: |
          for i in {1..60}; do
            if nc -z localhost 5900 2>/dev/null; then
              echo "VNC ready"
              exit 0
            fi
            echo "Waiting for VNC... ($i/60)"
            sleep 2
          done
          echo "VNC service did not start. Container logs:"
          docker logs vnc-test
          exit 1

      - name: Run VNC integration tests
        run: cargo test -p guacr-vnc --test integration_test -- --include-ignored --test-threads=1
        env:
          TEST_VNC_HOST: localhost
          TEST_VNC_PORT: 5900
          TEST_VNC_PASSWORD: alpine

      - name: Install Chromium for RBI tests
        run: |
          sudo apt-get update
          sudo apt-get install -y chromium-browser
          chromium-browser --version

      - name: Run RBI integration tests
        run: cargo test -p guacr-rbi --test integration_test --features chrome -- --include-ignored --test-threads=1
        env:
          CHROMIUM_PATH: /usr/bin/chromium-browser

      - name: Cleanup containers
        if: always()
        run: |
          docker stop telnet-test || true
          docker rm telnet-test || true
          docker stop rdp-test || true
          docker rm rdp-test || true
          docker stop vnc-test || true
          docker rm vnc-test || true

  # ============================================================================
  # Security Audit
  # ============================================================================
  security:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install cargo-audit
        run: cargo install cargo-audit

      - name: Run security audit
        run: cargo audit
        continue-on-error: true  # Don't fail PR on audit warnings

  # ============================================================================
  # Documentation
  # ============================================================================
  docs:
    name: Documentation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install FreeRDP development libraries
        run: |
          sudo apt-get update
          sudo apt-get install -y freerdp3-dev libwinpr3-dev

      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: false

      - name: Check documentation
        # Note: Not using --all-features because CEF requires binaries to compile
        run: cargo doc --no-deps
        env:
          RUSTDOCFLAGS: -D warnings
